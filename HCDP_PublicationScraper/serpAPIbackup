import os
import serpapi
import sys
from dotenv import load_dotenv

def main():
    # Load environment variables from .env file
    load_dotenv()
    
    print("--- SerpAPI Publication Downloader ---")
    
    # Get API key from environment or prompt user
    api_key = os.getenv("SerpApi")
    if not api_key:
        print("SerpAPI Key not found in environment variables.")
        api_key = input("Please enter your SerpAPI Key: ").strip()
    
    if not api_key:
        print("Error: API Key is required to run this script.")
        return

    params = {
        "engine": "google_scholar",  # Use the Google Scholar engine
        "num": "100",                # Number of results    
        #"q": "data science PDF",     # Your search query
        "oi": "bibs",                # Bibiography
        "cites": "11258593421370337345", # Paper number
        "hl": "en",                  # Language parameter
    }

    print("Searching Google Scholar via SerpAPI...")
    
    try:
        client = serpapi.Client(api_key=api_key)
        results = client.search(params).as_dict()

        # Iterate over organic results and look for PDF links in the 'resources' field
        if "organic_results" in results:
            found_count = 0
            for result in results["organic_results"]:
                title = result.get("title")
                link = result.get("link")
                resources = result.get("resources")

                print(f"\nTitle: {title}")
                print(f"Main Link: {link}")

                if resources:
                    for resource in resources:
                        if resource.get("file_format") == "PDF":
                            print(f"  [PDF Found]: {resource.get('link')}")
                            found_count += 1
                print("-" * 20)
            
            if found_count == 0:
                print("\nNo PDF links were found in the results.")
            else:
                print(f"\nFound {found_count} PDF links.")
        else:
            print("No results found or an error occurred in the search.")

    except Exception as e:
        if "401" in str(e):
            print("\nError: Invalid API Key (401 Unauthorized).")
        elif "403" in str(e):
            print("\nError: API Key is blocked or quota exceeded (403 Forbidden).")
        else:
            print(f"\nAn error occurred: {e}")

if __name__ == "__main__":
    main()

